#!/usr/bin/env python
#-*-coding:utf-8-*-

import json
import scrapy
import requests
from lxml import etree
from ..items import LanrenItem



class LanrenSpider(scrapy.Spider):
    name = 'lanren'
    #allowed_domains = ['http://mobile.ximalaya.com/']
    start_urls = [('http://www.lrts.me/book/category/1/recommend/{}/20').format(i) for i in range(1, 202)]

    def parse(self, response):
        item = LanrenItem()
        tree = etree.HTML(response.body)
        albumid = tree.xpath("//div[@class='book-item-r']/a/@href")
        for id in albumid:
            albumurl = 'http://www.lrts.me{}'.format(id)
            CreateTime = (etree.HTML((requests.get(albumurl)).content)).xpath("//time")[0].text.split(':')[1]
            item['AlbumUrl'] = albumurl
            item['CreateTime'] = CreateTime
            jsonurl = 'http://43.243.130.55/yyting/bookclient/ClientGetBookDetail.action?id={}'.format(id.split('/')[2])
            return scrapy.Request(url=jsonurl, meta={'item': item}, callback=self.parse_album, dont_filter=True)

    def parse_album(scrapy, response):
        #item = LanrenItem()
        item = response.meta['item']
        pagecode = json.loads(response.body)
        item['NickName'] = pagecode['announcer']
        item['PlayCounts'] = pagecode['play']
        item['UpdateTime'] = pagecode['update']
        item['SoundNumbers'] = pagecode['sections']
        item['AlbumTitle'] = pagecode['name']
        item['SoundType'] = pagecode['type']
        #print item
        yield item
